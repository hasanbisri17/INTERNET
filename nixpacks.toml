# Nixpacks Configuration for Laravel + Filament Application
# EasyPanel Deployment

# Providers - PHP and Node.js
[phases.setup]
nixPkgs = ["php82", "php82Extensions.pdo", "php82Extensions.pdo_mysql", "php82Extensions.mbstring", "php82Extensions.xml", "php82Extensions.curl", "php82Extensions.zip", "php82Extensions.gd", "php82Extensions.bcmath", "php82Extensions.intl", "php82Packages.composer", "nodejs_20"]

# Install phase - setup directories and install dependencies
[phases.install]
cmds = [
    "mkdir -p bootstrap/cache",
    "mkdir -p storage/framework/cache",
    "mkdir -p storage/framework/sessions",
    "mkdir -p storage/framework/views",
    "mkdir -p storage/logs",
    "chmod -R 777 bootstrap/cache",
    "chmod -R 777 storage",
    "composer install --no-dev --prefer-dist --optimize-autoloader --ignore-platform-reqs",
    "npm ci --legacy-peer-deps"
]

# Build phase - compile assets
[phases.build]
cmds = [
    "npm run build",
    "php artisan storage:link || true",
    "php artisan filament:cache-components || true"
]

# Start command for production
[start]
cmd = "mkdir -p bootstrap/cache storage/framework/cache storage/framework/sessions storage/framework/views storage/logs && chmod -R 777 bootstrap/cache storage && php artisan config:clear && php artisan route:clear && php artisan view:clear && php artisan migrate --force || true && php artisan config:cache && php artisan route:cache && php artisan view:cache && php artisan serve --host=0.0.0.0 --port=${PORT:-8080}"
