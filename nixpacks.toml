# Nixpacks Configuration for Laravel + Filament Application
# EasyPanel Deployment

# Providers - PHP and Node.js
[phases.setup]
nixPkgs = ["php82", "php82Extensions.pdo", "php82Extensions.pdo_mysql", "php82Extensions.mbstring", "php82Extensions.xml", "php82Extensions.curl", "php82Extensions.zip", "php82Extensions.gd", "php82Extensions.bcmath", "php82Extensions.intl", "php82Packages.composer", "nodejs_20"]

# Install phase - setup directories and install dependencies
[phases.install]
cmds = [
    "mkdir -p bootstrap/cache",
    "mkdir -p storage/framework/cache",
    "mkdir -p storage/framework/sessions",
    "mkdir -p storage/framework/views",
    "mkdir -p storage/logs",
    "chmod -R 777 bootstrap/cache",
    "chmod -R 777 storage",
    "composer install --no-dev --prefer-dist --optimize-autoloader --ignore-platform-reqs --no-scripts",
    "npm ci --legacy-peer-deps"
]

# Build phase - compile assets only
[phases.build]
cmds = [
    "npm run build"
]

# Start command for production
# NOTE: Do NOT cache routes as Filament registers routes dynamically
# Includes background scheduler (schedule:run loop) and queue worker
[start]
cmd = "mkdir -p bootstrap/cache storage/framework/cache storage/framework/sessions storage/framework/views storage/logs && chmod -R 777 bootstrap/cache storage && php artisan package:discover --ansi || true && php artisan storage:link || true && php artisan vendor:publish --tag=laravel-assets --ansi --force || true && php artisan filament:assets || true && php artisan config:clear && php artisan route:clear && php artisan view:clear && php artisan migrate --force || true && php artisan config:cache && php artisan view:cache && php artisan filament:cache-components || true && (while true; do php artisan schedule:run --verbose --no-interaction >> storage/logs/schedule.log 2>&1; sleep 60; done) & php artisan queue:work --sleep=3 --tries=3 --max-time=3600 --memory=256 >> storage/logs/queue.log 2>&1 & php artisan serve --host=0.0.0.0 --port=${PORT:-8080}"
